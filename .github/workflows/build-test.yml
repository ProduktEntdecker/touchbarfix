name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify Swift Installation
      run: |
        swift --version
        xcodebuild -version
    
    - name: Build TouchBarFix
      run: |
        cd App
        swift build -c release
    
    - name: Run Tests
      run: |
        cd App
        swift test
    
    - name: Verify Build Output
      run: |
        cd App
        ls -la .build/release/ || echo "Release directory not found"
        if [ -f .build/release/TouchBarFix ]; then
          echo "TouchBarFix binary found"
          file .build/release/TouchBarFix
        else
          echo "TouchBarFix binary not found"
          ls -la .build/ || echo "Build directory not found"
        fi
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: TouchBarFix-Build-${{ github.sha }}
        path: |
          App/.build/release/TouchBarFix
          App/.build/release/*.dSYM