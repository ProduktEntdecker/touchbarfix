#!/bin/bash

# TouchBarFix Linear Integration - "work on PRO-X" Command
# This script enables new Claude Code instances to work with Linear issues
#
# Usage:
#   ./work-on PRO-41
#   ./work-on 41  (PRO- prefix is optional)

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Check if issue number was provided
if [ -z "$1" ]; then
    echo -e "${RED}âŒ Usage: ./work-on <issue-number>${NC}"
    echo -e "${BLUE}Examples:${NC}"
    echo "  ./work-on PRO-41"
    echo "  ./work-on 41"
    exit 1
fi

# Extract issue number (remove PRO- prefix if present)
ISSUE_NUM=$(echo "$1" | sed 's/PRO-//')

# Validate that issue number is numeric
if ! [[ "$ISSUE_NUM" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}âŒ Invalid issue number: $1${NC}"
    echo "Please provide a numeric issue number (e.g., 41 or PRO-41)"
    exit 1
fi

echo -e "${BLUE}ğŸš€ Working on PRO-${ISSUE_NUM}...${NC}\n"

# Step 1: Get issue details
echo -e "${YELLOW}ğŸ“‹ Fetching issue details...${NC}"
node "$SCRIPT_DIR/linear-bridge.js" get-issue "$ISSUE_NUM"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Failed to fetch issue details${NC}"
    exit 1
fi

echo ""

# Step 2: Update status to "In Progress"
echo -e "${YELLOW}ğŸ”„ Updating status to 'In Progress'...${NC}"
node "$SCRIPT_DIR/linear-bridge.js" update-status "$ISSUE_NUM" "In Progress"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Failed to update status${NC}"
    exit 1
fi

# Step 3: Add a progress comment
COMMENT="ğŸ¤– Claude Code: Started working on PRO-${ISSUE_NUM}. Issue status updated to In Progress."
echo -e "${YELLOW}ğŸ’¬ Adding progress comment...${NC}"
node "$SCRIPT_DIR/linear-bridge.js" add-comment "$ISSUE_NUM" "$COMMENT"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Failed to add comment${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… Successfully started work on PRO-${ISSUE_NUM}!${NC}"
echo -e "${BLUE}ğŸ”— View in Linear: https://linear.app/produktentdecker/issue/PRO-${ISSUE_NUM}${NC}"
echo ""
echo -e "${YELLOW}ğŸ“ Next steps:${NC}"
echo "1. Implement the required changes"
echo "2. Test your implementation"  
echo "3. Update Linear with progress comments"
echo "4. Mark as Done when complete"